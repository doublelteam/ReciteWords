var jsons = new Array();
jsons[0] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "选择",
	"options0" : "A选项内容",
	"options1" : "B选项内容",
	"options2" : "C选项内容",
	"options3" : "D选项内容",
	"choose" : "1",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "111",
}
jsons[1] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈2",
	"type" : "选择",
	"options0" : "A",
	"options1" : "B",
	"options2" : "C",
	"options3" : "D",
	"choose" : "1",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "112",
}
jsons[2] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈3",
	"type" : "选择",
	"options0" : "正确",
	"options1" : "错误",
	"options2" : "错误",
	"options3" : "错误",
	"choose" : "1",
	"right-key" : "1",
	"accuracy" : "50%",
	"id" : "113",
}
jsons[3] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈4",
	"type" : "选择",
	"options0" : "A",
	"options1" : "B",
	"options2" : "C",
	"options3" : "D",
	"choose" : "2",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "114",
}
jsons[4] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈5",
	"type" : "选择",
	"options0" : "A",
	"options1" : "B",
	"options2" : "C",
	"options3" : "D",
	"choose" : "2",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "115",
}
jsons[5] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈6",
	"type" : "选择",
	"options0" : "A",
	"options1" : "B",
	"options2" : "C",
	"options3" : "D",
	"choose" : "3",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "116",
}
jsons[6] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "选择",
	"options0" : "A",
	"options1" : "B",
	"options2" : "C",
	"options3" : "D",
	"choose" : "1",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "117",
}
jsons[7] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "选择",
	"options0" : "A",
	"options1" : "B",
	"options2" : "C",
	"options3" : "D",
	"choose" : "1",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "118",
}
jsons[8] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "选择",
	"options0" : "A",
	"options1" : "B",
	"options2" : "C",
	"options3" : "D",
	"choose" : "3",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "119",
}
jsons[9] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "选择",
	"options0" : "A",
	"options1" : "B",
	"options2" : "C",
	"options3" : "D",
	"choose" : "4",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "120",
}
jsons[10] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "判断",
	"options0" : "正确",
	"options1" : "错误",
	"choose" : "2",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "121",
}
jsons[11] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "判断",
	"options0" : "正确",
	"options1" : "错误",
	"choose" : "1",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "122",
}
jsons[12] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "判断",
	"options0" : "正确",
	"options1" : "错误",
	"choose" : "2",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "123",
}
jsons[13] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "判断",
	"options0" : "正确",
	"options1" : "错误",
	"choose" : "1",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "124",
}
jsons[14] = {
	"title" : "哈哈哈哈哈哈哈或哈哈哈",
	"type" : "判断",
	"options0" : "正确",
	"options1" : "错误",
	"choose" : "2",
	"right-key" : "2",
	"accuracy" : "50%",
	"id" : "125",
}
var a = new Array();
a[0] = {
	"question":"少时诵诗1_____",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1123",
};
a[1] = {
	"question":"少时诵诗1_____",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1124",
};
a[2] = {
	"question":"少时诵诗1_____",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1125",
};
a[3] = {
	"question":"少时诵诗1_____",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1126",
};
a[4] = {
	"question":"少时诵诗1_____",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1127",
};
var b = new Array();
b[0] = {
	"question":"你快乐吗？",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1223",
};
b[1] = {
	"question":"你快乐吗？",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1224",
};
b[2] = {
	"question":"你快乐吗？",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1225",
};
b[3] = {
	"question":"你快乐吗？",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1226",
};
b[4] = {
	"question":"你快乐吗？",
	"Sanswer" : "adasdasd",
	"right-key" : "aqwe1332qw",
	"id" : "1227",
};
function datas (){
	this.title = "编译原理测试";
	this.chooseAndTF = [];  //选择和判断题放一起
	this.fill = [];
	this.ask = [];
	this.time = "";
}
var data = new Array();
data[0] = "编译原理测试1";
data[1] = new Array();
data[2] = new Array();
data[3] = new Array();
data[4] = "2018-12-06 10:00"
for (var i = 0; i < jsons.length; i++) {
	data[1][i] = jsons[i];
}
for (var i = 0; i < a.length; i++) {
	data[2][i] = a[i];
}
for (var i = 0; i < b.length; i++) {
	data[3][i] = b[i]
}
console.log(data);

//以上内容是前端测试写的数据，写后台时注释掉，输出的data是所需要的数据类型


//存储试卷分数的数组,-1表示未评分
var grade = new Array();
for (var i = 0; i < 25; i++) {
	grade[i] = -1;
}
//定义存放试题id的数组
var ids = new Array();
for (var i = 0; i < 25; i++) {
	ids[i] = "hhh";
}
//请求试卷信息
function get_toMarkExam(){
	$.ajax({
		url : "/MarkExam",
		type : "POST",
		processData : false,
		contentType : false,
		success : function(data){
				initExam(data);
		},
		error : function(){
			alert("请求试卷信息失败，请重试！");
		}
	});
}

//初始化试卷
function initExam(data){
	if(!data[0]){
		alert("试卷标题加载出错");
		document.getElementById("title").innerHTML = "考试详情";
	}else {
		document.getElementById("title").innerHTML = data[0];
	}
	if(!data[4]){
		alert("考试时间加载出错");
	}else{
		document.getElementById("timer").innerHTML = data[4];
	}
	var jsons = new Array();
	jsons = data[1];
	for (var i = 0; i < jsons.length; i++) {
		//创建试题最外的div
		var dv = document.createElement("div");
		dv.className = "question";
	
		//创建题干p
		var p = document.createElement("p");
		p.className = "pan";
		p.innerHTML = (i+1).toString() + "、" + jsons[i]["title"];
	
		//创建选项ul
		var ul = document.createElement("ul");
		ul.className = "collection";
		ul.id = "u" + (i+1);
		ul.setAttribute("index",i+1);
		var tOrf = document.createElement("li");
		tOrf.className = "";
		ids[i] = jsons[i]["id"];
		if(jsons[i]["type"] == "选择"){
			for (var j = 0; j < 4; j++) {
				//创建每个选项li
				var li = document.createElement("li");
				li.className = "collection-item";
				var label = document.createElement("label");
				label.innerHTML = String.fromCharCode(65+j) + "、" + jsons[i]["options" + j];
				li.appendChild(label);
				ul.appendChild(li);
				//正确答案绿色背景
				if(jsons[i]["right-key"] == j+1){
					li.style.backgroundColor = "green";
					li.children[0].style.color = "#fff";
				}
				if(jsons[i]["right-key"] != jsons[i]["choose"] && jsons[i]["choose"] == j+1){
					li.style.backgroundColor = "red";
					li.children[0].style.color = "#fff";
				}
			}
			if(jsons[i]["right-key"] == jsons[i]["choose"]){
				var choose = String.fromCharCode(64+parseInt(jsons[i]["choose"]));
				tOrf.innerHTML = "学生作答：" + choose + "，答对了！";
				tOrf.className = "true-one";
				var ID = "c" + (i + 1);
				document.getElementById(ID).style.backgroundColor = "green";
				grade[i] = 2;
			}else{
				var choose = String.fromCharCode(64+parseInt(jsons[i]["choose"]));
				tOrf.innerHTML = "学生作答：" + choose + "，答错了！";
				tOrf.className = "false-one";
				var ID = "c" + (i + 1);
				document.getElementById(ID).style.backgroundColor = "red";
				grade[i] = 0;
			}
		}else {
			for (var j = 0; j < 2; j++) {
				//创建每个选项li
				var li = document.createElement("li");
				li.className = "collection-item";
				var label = document.createElement("label");
				label.innerHTML = jsons[i]["options" + j];
				li.appendChild(label);
				ul.appendChild(li);
				//正确答案绿色背景
				if(jsons[i]["right-key"] == j+1){
					li.style.backgroundColor = "green";
					li.children[0].style.color = "#fff";
				}
				if(jsons[i]["right-key"] != jsons[i]["choose"] && jsons[i]["choose"] == j+1){
					li.style.backgroundColor = "red";
					li.children[0].style.color = "#fff";
				}
			}
			var choose = jsons[i]["right-key"] == jsons[i]["choose"]? "学生作答：'正确'，答对了！" : "学生作答：‘错误’，答错了！";
			tOrf.innerHTML = choose;
			jsons[i]["right-key"] == jsons[i]["choose"]? grade[i] = 1 : grade[i] =0;
			tOrf.className = jsons[i]["right-key"] == jsons[i]["choose"]? "true-one":"false-one";
			var ID = "c" + (i + 1);
			document.getElementById(ID).style.backgroundColor = jsons[i]["right-key"] == jsons[i]["choose"]? "green":"red";
		
		}
		var answer = String.fromCharCode(64+parseInt(jsons[i]["right-key"]));
		var percen = document.createElement("li");
		percen.className = "info collection-item";

		percen.innerHTML = "本题正确答案：" + answer + ";" + "<br/>"+"正确率为：" + jsons[i]["accuracy"];
		ul.appendChild(percen);
		ul.appendChild(tOrf);
		dv.appendChild(p);
		dv.appendChild(ul);
		

		//创建定位的锚点
		var division = document.createElement("div");
		division.id = "d" + (i+1);
		division.className = "divi";
		document.getElementById("contain").appendChild(division);
		document.getElementById("contain").appendChild(dv);
	}

	//填空
	var a = new Array();
	a = data[2];
	var contain2 = document.getElementById("contain2");
	for (var i = 0; i < a.length; i++) {
		ids[i+15] = a[i]["id"];
		var dv = document.createElement("div");
		dv.className = "question";
		var p = document.createElement("p");
		p.innerHTML = (i+16).toString() + "、" + a[i]["question"];
		p.className = "pan";
		dv.appendChild(p);
		var divi = document.createElement("div");
		divi.className = "divider";
		dv.appendChild(divi);
		

		var p2 = document.createElement("p");
		p2.innerHTML = "参考答案：" + a[i]["right-key"];
		p2.className = "answer";
		dv.appendChild(p2);

		var p3 = document.createElement("p");
		p3.innerHTML = "学生作答：" + a[i]["Sanswer"];
		p3.className = "answer";
		dv.appendChild(p3);

		var input = document.createElement("input");
		input.placeholder = "请在这里给出本题分数";
		input.id = 'fill' + i;
		input.style.backgroundColor = "#fff";
		input.style.marginLeft = "10%";
		input.style.width = "40%";
		input.name = 'fill';

		input.setAttribute("index",i+16);
		input.onblur = judgeAndUpdate;

		
		dv.appendChild(input);

		//定位锚点
		var division = document.createElement("div");
		division.id = "d" + (i+16);
		division.className = "divi";
		contain2.appendChild(division);
		contain2.appendChild(dv);

		// var ID = "c" + (i + 16);
		// document.getElementById(ID).style.backgroundColor = "orange";
	}

	//问答题
	var b = new Array();
	b = data[3];
	var contain3 = document.getElementById('contain3');
	for (var i = 0; i < b.length; i++) {
		ids[i+20] = b[i]["id"];
		var dv = document.createElement("div");
		dv.className = "question";
		var p = document.createElement("p");
		p.innerHTML = (i+21).toString() + "、" + b[i]["question"];
		p.className = "pan";
		dv.appendChild(p);
		var divi = document.createElement("div");
		divi.className = "divider";
		dv.appendChild(divi);
		var p2 = document.createElement("p");
		p2.innerHTML = "参考答案：" + a[i]["right-key"];
		p2.className = "answer";
		dv.appendChild(p2);

		var p3 = document.createElement("p");
		p3.innerHTML = "学生作答：" + a[i]["Sanswer"];
		p3.className = "answer";
		dv.appendChild(p3);
		
		var input = document.createElement("input");
		input.placeholder = "请在这里给出本题分数";
		input.id = 'fill' + i;
		input.style.backgroundColor = "#fff";
		input.style.marginLeft = "10%";
		input.style.width = "40%";
		input.name = 'fill';

		input.setAttribute("index",i+21);
		input.onblur = judgeAndUpdate;

		
		dv.appendChild(input);

		//定位锚点
		var division = document.createElement("div");
		division.id = "d" + (i+21);
		division.className = "divi";
		contain3.appendChild(division);
		contain3.appendChild(dv);

		// var ID = "c" + (i + 21);
		// document.getElementById(ID).style.backgroundColor = "orange";
		// 
	}
}
//initExam(data);

//点击右侧题目导航栏跳转至对应题目
function f1() {
	var index = this.id;
	var id;
	if(index.length == 2)
		index = index.charAt(1);
	else
		index = index.substring(1,3);
	id = "#" + "d" + index;
	console.log(id);
	window.location.href = id;
}
function located() {
	var dvs = document.getElementsByClassName("dd");
	for (var i = 0; i < dvs.length; i++) {
		dvs[i].onclick = f1;
	}
}
located();

//判断输入评分是否为数字、小数、整数
function isNumber(val) {
    var regPos = /^\d+(\.\d+)?$/; //非负浮点数
    var regNeg = /^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$/; //负浮点数
    if(regPos.test(val) || regNeg.test(val))
        return true;
    else
        return false;
}

//判断评分是否为整数，如果需要再使用
function isIneger(val) {
	if(val % 1 === 0)
		return true;
	return false;
}

//判断评分并且更新成绩和题目导航背景
function judgeAndUpdate(){
	var index = this.getAttribute("index");
	var id = "c" + index;
	if(!this.value){
		document.getElementById(id).style.backgroundColor = "";
		grade[index-1] = -1;
		getScore();
		return false;
	}
	if(!isNumber(this.value)){
		alert("评分必须是一个数字！");
		grade[index-1] = -1;
		document.getElementById(id).style.backgroundColor = "";
		getScore();
		return false;
	}
	var num = parseFloat(this.value);
	if(index <= 20 ){
		if(num > 5 || num < 0){
			alert("评分必须在0-5之间");
			grade[index-1] = -1;
			document.getElementById(id).style.backgroundColor = "";
			getScore();
			return false;
		}
	}
	else{
		if(num > 10 || num < 0){
			alert("评分必须在0-10之间");
			grade[index-1] = -1;
			document.getElementById(id).style.backgroundColor = "";
			getScore();
			return false;
		}
	}
	console.log(num);
	grade[index-1] = num;
	console.log(grade);
	document.getElementById(id).style.backgroundColor = "orange";
	getScore();
}

function getScore() {
	var one = 0;
	var two = 0;
	var three = 0;
	var four = 0;
	for (var i = 0; i < 10; i++)
        if(grade[i] != -1)
            one += grade[i];
	for (var i = 10; i < 15; i++)
        if(grade[i] != -1)
            two += grade[i];
	for (var i = 15; i < 20; i++)
		if(grade[i] != -1)
		three += grade[i];
	for (var i = 20; i < 25; i++)
		if(grade[i] != -1)
		four += grade[i];
	document.getElementById("score").innerHTML = one + " + " + two + " + " + three + " + " + four + " = ";
	document.getElementById("score2").innerHTML = one + two + three + four + "分";
}

getScore();



//提交试卷批阅结果
document.getElementById("submit").onclick = function(){
	var count = 0;
	for (var i = 0; i < grade.length; i++) {
		if(grade[i] != -1)
			count ++;
	}
	if(count != 25){
		alert("试卷还没批改完");
		return false;
	}
	console.log(count);
	if(confirm("提交之后将无法更改，您确定真的提交批改结果吗？") == true){
		function data() {
			this.ids = new Array();
			this.grade = new Array();
		}
		var idAndGrade = new data();
		for (var i = 0; i < grade.length; i++) {
			idAndGrade.grade[i] = grade[i];
			idAndGrade.ids[i] = ids[i];
		}
		console.log( idAndGrade);
		var f=new FormData();
		f.append("ids",ids);
		f.append("grade",grade);
		$.ajax({
			url : "/teacher/MarkSubmit",
			type : "POST",
			data : f,
			processData : false,
			contentType : false,
			success : function(result){
				if(result.code == "success"){
                    alert("提交成功");
                    window.location.href="/teacher";
				}
				else
					alert("提交失败，请重新提交一次");
			},
			error : function(){
				alert("网络原因提交失败，请重试！");
			}
		});
	}
}


//返回首页按钮
document.getElementById("goback").onclick = function(){
	if(confirm("返回首页将丢失目前的批改，您确认要回到首页吗？") == true){
		window.location.href = "./teacher";
	}
}


window.addEventListener("beforeunload", function (e) {
    (e || window.event).returnValue = '确定离开此页吗？';
});


//加载导航栏学生信息
function get_toMarkStudentInfo(){
	$.ajax({
		url : "/teacher/getStudentInfo",
		type : "POST",
		processData : false,
		contentType : false,
		success : function(result){
			if(result.code == "fail"){
				alert("学生信息加载失败" + result.mes);
				return false;
			}
			init_StudentInfo(result);
		}
	});
}
function init_StudentInfo(result){
	document.getElementById("StudentNum").innerHTML = "学号：" + result.Snum;
	document.getElementById("StudentName").innerHTML = "姓名：" + result.Sname;
	document.getElementById("StudentGrade").innerHTML = "年级：" + result.Sgrade;
	document.getElementById("StudentClass").innerHTML = "班级：" + result.SClass;
}
// init_StudentInfo({
// 	"Snum" : "201630600333",
// 	"Sname" : "糖好酸",
// 	"Sgrade" : "2016",
// 	"SClass" : "网络工程"
// });

//设置页面卷积时标题置顶
//
//获取当前页面卷积高度
 function getScroll() {
    var obj = {
      left: window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft||0,
      top: window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0
    };
    return obj;
  }

//设置页面卷积固定导航栏
  window.onscroll = function(){
    if(getScroll().top>=65){
      document.getElementById('title').className = "fixed-title teal";
      // document.getElementById("one").className = "fixed-one";
      document.getElementById('one').style.marginTop = 180 + "px";
    }
    else{
      document.getElementById('title').className = "title";
      // document.getElementById("one").className = "";
      document.getElementById('one').style.marginTop = 10 + "px";
    }
  }